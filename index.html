<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Windows 98 - Gravity.exe</title>
    <style>
        /* --- Windows 98 Design System V9.0 (Anti-Crash) --- */
        :root {
            --win-gray: #c0c0c0; --win-dark-gray: #808080; --win-light-gray: #ffffff;
            --win-black: #000000; --win-blue: #000080; --win-teal: #008080;
        }
        @font-face { font-family: 'Pixelated MS Sans'; src: local('MS Sans Serif'), local('Arial'), sans-serif; }
        body {
            margin: 0; overflow: hidden; background-color: var(--win-teal);
            font-family: 'Pixelated MS Sans', Tahoma, sans-serif; font-size: 12px;
            user-select: none; -webkit-user-select: none; cursor: default;
        }
        /* æ‰«æçº¿ï¼šæ›´æ·¡ï¼Œå‡å°‘æ€§èƒ½æ¶ˆè€— */
        body::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(to bottom, rgba(0,0,0,0.02), rgba(0,0,0,0.02) 1px, transparent 1px, transparent 2px);
            pointer-events: none; z-index: 999999; opacity: 0.2;
        }
        .win-bevel-out {
            border-top: 2px solid var(--win-light-gray); border-left: 2px solid var(--win-light-gray);
            border-right: 2px solid var(--win-black); border-bottom: 2px solid var(--win-black);
            background-color: var(--win-gray); box-shadow: inset -1px -1px 0px var(--win-dark-gray), inset 1px 1px 0px #dfdfdf;
        }
        .win-bevel-in {
            border-top: 2px solid var(--win-dark-gray); border-left: 2px solid var(--win-dark-gray);
            border-right: 2px solid var(--win-light-gray); border-bottom: 2px solid var(--win-light-gray);
            background-color: #ffffff; box-shadow: inset 1px 1px 0px var(--win-black), inset -1px -1px 0px #dfdfdf;
        }
        .win-button {
            background: var(--win-gray); color: var(--win-black);
            border-top: 1px solid var(--win-light-gray); border-left: 1px solid var(--win-light-gray);
            border-right: 1px solid var(--win-black); border-bottom: 1px solid var(--win-black);
            box-shadow: inset -1px -1px 0px var(--win-dark-gray), inset 1px 1px 0px #dfdfdf;
            padding: 4px 8px; font-size: 11px; cursor: pointer; outline: none;
            display: flex; align-items: center; justify-content: center; min-width: 60px;
            pointer-events: auto; position: relative;
        }
        .win-button:active {
            border-top: 1px solid var(--win-black); border-left: 1px solid var(--win-black);
            border-right: 1px solid var(--win-light-gray); border-bottom: 1px solid var(--win-light-gray);
            padding: 5px 7px 3px 9px; background: #d4d4d4;
        }
        #desktop {
            position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 28px);
            padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; gap: 20px; align-items: flex-start; z-index: 1;
        }
        .desktop-icon {
            width: 70px; display: flex; flex-direction: column; align-items: center; color: white; cursor: pointer; text-align: center; padding: 5px; border: 1px solid transparent;
        }
        .desktop-icon:hover { border: 1px dotted white; background: rgba(0,0,80, 0.2); }
        .desktop-icon svg { width: 32px; height: 32px; margin-bottom: 4px; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.5)); }
        
        .win-window {
            position: absolute; background-color: var(--win-gray); padding: 2px;
            display: flex; flex-direction: column; box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
            top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100;
        }
        .win-window.modal { z-index: 1000; }
        .title-bar {
            background: linear-gradient(to right, var(--win-blue), #1084d0); color: white;
            padding: 3px 4px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; height: 18px; cursor: default;
        }
        .close-btn { width: 16px; height: 14px; line-height: 10px; font-family: sans-serif; font-weight: bold; padding: 0; min-width: 16px; }

        #game-window { width: 800px; height: 600px; max-width: 96%; max-height: 80%; top: 48%; }
        #game-container { flex-grow: 1; background-color: #000; position: relative; margin-top: 2px; overflow: hidden; cursor: crosshair; }
        canvas { display: block; width: 100%; height: 100%; }
        #game-ui-bar { position: absolute; top: 6px; left: 6px; display: flex; flex-wrap: wrap; gap: 6px; pointer-events: none; z-index: 10; }

        #bios-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; color: #ccc;
            font-family: 'Courier New', monospace; font-weight: bold; padding: 20px; box-sizing: border-box;
            z-index: 999990; display: none; flex-direction: column; pointer-events: all; font-size: 14px; line-height: 1.5;
        }
        .dial-icon { width:48px; height:48px; float:left; margin-right:10px; }
        .input-row { margin-bottom: 8px; display: flex; align-items: center; }
        .input-label { width: 80px; }
        .win-input { border: 1px solid gray; box-shadow: inset 1px 1px 0 black; padding: 2px; width: 150px; font-family: inherit; }
        .msg-icon { width: 32px; height: 32px; margin-right: 15px; }
        .msg-content { display: flex; align-items: center; padding: 15px; min-width: 250px; }
        
        #taskbar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 28px;
            background: var(--win-gray); border-top: 2px solid var(--win-light-gray);
            display: flex; align-items: center; padding: 2px; box-sizing: border-box; z-index: 10000;
        }
        #time-display {
            margin-left: auto; margin-right: 2px; padding: 2px 10px;
            border: 1px solid var(--win-dark-gray); background: var(--win-gray);
            box-shadow: inset 1px 1px 0 white, inset -1px -1px 0 var(--win-dark-gray);
            min-width: 60px; text-align: center;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="desktop">
        <div class="desktop-icon" ondblclick="openGame()" ontouchend="openGame()">
            <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="8" y="8" width="16" height="16" fill="black"/><rect x="10" y="6" width="12" height="2" fill="black"/><rect x="10" y="24" width="12" height="2" fill="black"/><rect x="6" y="10" width="2" height="12" fill="black"/><rect x="24" y="10" width="2" height="12" fill="black"/><circle cx="16" cy="16" r="6" fill="#00FFFF"/><path d="M4 16h24" stroke="yellow" stroke-width="2"/>
            </svg>
            <span>Gravity.exe</span>
        </div>
        <div class="desktop-icon" onclick="openDialup()">
            <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="2" y="6" width="12" height="10" fill="#C0C0C0" stroke="black"/><rect x="18" y="6" width="12" height="10" fill="#C0C0C0" stroke="black"/><rect x="4" y="8" width="8" height="6" fill="#008080"/><rect x="20" y="8" width="8" height="6" fill="#008080"/><path d="M8 16v4h16v-4" stroke="black" fill="none"/><rect x="6" y="22" width="20" height="2" fill="#008080"/>
            </svg>
            <span>ç½‘ä¸Šé‚»å±…</span>
        </div>
        <div class="desktop-icon" onclick="trashTalk()">
            <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                <rect x="6" y="6" width="20" height="2" fill="white" stroke="black"/><rect x="8" y="8" width="16" height="18" fill="transparent" stroke="black"/><line x1="12" y1="10" x2="12" y2="24" stroke="black"/><line x1="16" y1="10" x2="16" y2="24" stroke="black"/><line x1="20" y1="10" x2="20" y2="24" stroke="black"/><rect x="9" y="18" width="4" height="4" fill="gray"/><rect x="15" y="20" width="3" height="3" fill="gray"/>
            </svg>
            <span>å›æ”¶ç«™</span>
        </div>
    </div>

    <div id="game-window" class="win-window win-bevel-out">
        <div class="title-bar">
            <div style="display:flex; align-items:center;">
                <svg viewBox="0 0 16 16" fill="white" xmlns="http://www.w3.org/2000/svg" style="width:16px;height:16px;margin-right:6px;"><circle cx="8" cy="8" r="6" stroke="white" stroke-width="2" fill="none"/><circle cx="8" cy="8" r="2" fill="white"/></svg>
                <span>Gravity Synthesizer - [Stable]</span>
            </div>
            <button class="close-btn win-button" onclick="closeGame()" onmousedown="event.stopPropagation()">X</button>
        </div>
        <div id="game-container" class="win-bevel-in">
            <canvas id="gameCanvas"></canvas>
            <div id="game-ui-bar">
                <div class="win-bevel-out" style="padding: 2px 4px; background:var(--win-gray); color:black; font-weight:bold; display:flex; align-items:center; pointer-events:auto; height: 22px;">
                    Score: <span style="background:white; border:1px solid gray; padding:0 4px; margin-left:4px; font-family:monospace;" id="score">0</span>
                </div>
                <button id="audioBtn" class="win-button" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()">
                    <span id="audio-icon">ğŸ”‡</span> <span id="audio-text">éŸ³æ•ˆ</span>
                </button>
                <button id="speedBtn" class="win-button" style="color: blue;" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()">
                    <span id="speed-text">âš¡ 1x</span>
                </button>
                <button id="bsodBtn" class="win-button" style="color: darkred;" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()">
                    <span id="bsod-text">ğŸ’£ å¼€å¯</span>
                </button>
                <button id="rebootBtn" class="win-button" style="font-weight:bold;" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()">
                    <span>ğŸ”„ é‡å¯</span>
                </button>
            </div>
            <div id="tutorial" style="position:absolute; bottom:20px; width:100%; text-align:center; pointer-events:none;">
                <span style="background:#ffffc0; border:1px solid black; padding:4px; font-size:11px; color:black; box-shadow: 2px 2px 0 black;">æç¤º: é•¿æŒ‰é¼ æ ‡äº§ç”Ÿå¼•åŠ› | å®‰å…¨æ¨¡å¼å·²å¯ç”¨</span>
            </div>
        </div>
    </div>

    <div id="dial-window" class="win-window win-bevel-out modal hidden" style="width: 350px;">
        <div class="title-bar"><span>è¿æ¥åˆ° æ¸¸æˆç½‘ç»œ...</span><button class="close-btn win-button" onclick="closeDialup()" onmousedown="event.stopPropagation()">X</button></div>
        <div style="padding: 15px;">
            <svg class="dial-icon" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 16h28M16 2v28" stroke="transparent"/><rect x="4" y="4" width="24" height="20" fill="#C0C0C0" stroke="black"/><rect x="8" y="8" width="16" height="8" fill="white" stroke="gray"/><rect x="6" y="26" width="20" height="2" fill="black"/></svg>
            <div style="margin-left: 60px;">
                <div class="input-row"><span class="input-label">ç”¨æˆ·å:</span><input type="text" value="User_98" class="win-input" disabled></div>
                <div class="input-row"><span class="input-label">å¯†ç :</span><input type="password" value="******" class="win-input" disabled></div>
                <div class="input-row"><span class="input-label">ç”µè¯å·ç :</span><input type="text" value="555-0199" class="win-input" disabled></div>
            </div>
            <div style="margin-top:20px; border-top: 1px solid white; box-shadow: 0 -1px 0 gray; padding-top:10px; display:flex; justify-content:flex-end; gap:10px;">
                <button class="win-button" style="width:80px;" onclick="startConnection()" onmousedown="event.stopPropagation()">è¿æ¥</button>
                <button class="win-button" style="width:80px;" onclick="closeDialup()" onmousedown="event.stopPropagation()">å–æ¶ˆ</button>
            </div>
            <div id="dial-status" style="margin-top:10px; height:20px; color:blue; font-style:italic;"></div>
        </div>
    </div>

    <div id="net-window" class="win-window win-bevel-out modal hidden" style="width: 320px; top:40%; left:55%;">
        <div class="title-bar"><span>ç½‘ä¸Šé‚»å±…</span><button class="close-btn win-button" onclick="closeNet()" onmousedown="event.stopPropagation()">X</button></div>
        <div class="win-bevel-in" style="background:white; height: 180px; padding:10px; overflow-y:auto; color:black;">
            <p style="color:green; margin:0 0 5px 0;">çŠ¶æ€: å·²è¿æ¥ (28.8 Kbps)</p>
            <hr style="border:0; border-top:1px dashed gray; margin:5px 0;">
            <table style="width:100%; font-size:11px; border-collapse: collapse;">
                <tr style="background:#ddd;"><th>æ’å</th><th>ç”¨æˆ·</th><th>åˆ†æ•°</th></tr>
                <tr><td>1</td><td>Admin</td><td>99999</td></tr>
                <tr><td>2</td><td>BillG</td><td>58000</td></tr>
                <tr><td>3</td><td>DoomGuy</td><td>6660</td></tr>
                <tr><td>4</td><td>[ä½ ]</td><td>0</td></tr>
            </table>
            <p style="margin-top:10px; color:gray; font-size:10px;">* æ­£åœ¨ç­‰å¾…æœåŠ¡å™¨å“åº”...</p>
        </div>
    </div>

    <div id="msg-window" class="win-window win-bevel-out modal hidden" style="min-width: 300px;">
        <div class="title-bar"><span id="msg-title">Error</span><button class="close-btn win-button" onclick="closeMsg()" onmousedown="event.stopPropagation()">X</button></div>
        <div class="msg-content">
            <svg class="msg-icon" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="14" fill="#A00" stroke="black"/><path d="M10 10l12 12M22 10l-12 12" stroke="white" stroke-width="4"/></svg>
            <span id="msg-text" style="max-width:200px;">Unknown Error</span>
        </div>
        <div style="padding: 10px; display:flex; justify-content:center;"><button class="win-button" style="width:80px;" onclick="closeMsg()" onmousedown="event.stopPropagation()">ç¡®å®š</button></div>
    </div>

    <div id="bios-screen">
        <div style="margin-bottom:20px;"><span style="color:white;">Award Modular BIOS v4.51PG, An Energy Star Ally</span><br>Copyright (C) 1984-98, Award Software, Inc.</div>
        <div>PENTIUM II - MMX CPU at 233MHz</div>
        <div>Memory Test : <span id="mem-test">0</span>K OK</div>
        <div id="bios-details" style="display:none; margin-top:10px;"><br>Award Plug and Play BIOS Extension v1.0A<br>Initialize Plug and Play Cards...<br>PNP Init Completed<br><br>Detecting Primary Master ... QUANTUM FIREBALL<br>Detecting Secondary Master ... CD-ROM DRIVE<br><br>Verifying DMI Pool Data .........<br><br>Starting Windows 98...</div>
    </div>

    <div id="taskbar" class="win-bevel-out">
        <button id="start-btn" class="win-button" style="font-weight:bold; padding:2px 6px; height:22px;"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="margin-right:4px;"><rect x="0" y="0" width="6" height="6" fill="#E85942"/><rect x="7" y="0" width="6" height="6" fill="#66CC60"/><rect x="0" y="7" width="6" height="6" fill="#4886E0"/><rect x="7" y="7" width="6" height="6" fill="#F4CF36"/></svg>å¼€å§‹</button>
        <div class="win-bevel-in" style="margin-left:4px; padding:2px 6px; background:var(--win-gray); border:none; box-shadow:inset 1px 1px 0 black; display:flex; align-items:center;"><div style="width:12px; height:12px; background:gray; margin-right:4px;"></div>Gravity.exe</div>
        <div style="flex-grow:1;"></div><div id="time-display" class="win-bevel-in">12:00 PM</div>
    </div>

    <script>
        const wins = {}; 
        setInterval(() => {
            const now = new Date(); let h = now.getHours(); const m = now.getMinutes().toString().padStart(2, '0');
            const ampm = h >= 12 ? 'PM' : 'AM'; h = h % 12 || 12;
            const el = document.getElementById('time-display'); if(el) el.textContent = `${h}:${m} ${ampm}`;
        }, 1000);

        const CONFIG = { friction: 0.98, gravity: 0.5, bounce: 0.7, baseSpawnRate: 100, colors: ['#c0c0c0', '#008080', '#000080', '#808000', '#800080', '#ff0000', '#ffff00', '#ffffff'] };

        // --- ä¿®å¤ç‰ˆéŸ³é¢‘å¼•æ“ï¼šé˜²æ­¢çˆ†éŸ³ ---
        const AudioEngine = {
            ctx: null, enabled: false, lastSoundTime: 0,
            init() {
                if (!this.ctx) { try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} }
                if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
            },
            play(freq, type='square') {
                if(!this.enabled || !this.ctx) return;
                const now = this.ctx.currentTime;
                // [å…³é”®ä¿®å¤]ï¼šå£°éŸ³èŠ‚æµé˜€ï¼Œ0.08ç§’å†…åªèƒ½æ’­æ”¾ä¸€ä¸ªå£°éŸ³ï¼Œé˜²æ­¢å †å åˆºè€³
                if(now - this.lastSoundTime < 0.08) return; 
                this.lastSoundTime = now;

                try {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, now);
                    // é™ä½é»˜è®¤éŸ³é‡
                    gain.gain.setValueAtTime(0.08, now); 
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                    osc.connect(gain); gain.connect(this.ctx.destination);
                    osc.start(); osc.stop(now + 0.3);
                } catch(e) {}
            },
            // [å…³é”®ä¿®å¤]ï¼šBSOD å£°éŸ³ä¸å†æ˜¯ Sawtoothï¼Œæ”¹ç”¨æŸ”å’Œçš„ Noise/Triangleï¼Œä¸”åªè§¦å‘ä¸€æ¬¡
            bsod() {
                this.play(150, 'triangle'); 
            },
            playDialSound() {
               // ç®€åŒ–æ‹¨å·éŸ³ï¼Œå‡å°‘Oscillatoræ•°é‡
               if(!this.enabled || !this.ctx) return;
               try {
                   this.play(440, 'square');
                   setTimeout(() => this.play(800, 'square'), 300);
               } catch(e) {}
            },
            stopDial() {}
        };

        const state = { orbs: [], particles: [], score: 0, width: 800, height: 600, pointer: { x:0, y:0, down:false }, frame: 0, gameActive: true, speedLevel: 1, currentSpawnRate: 100, bsodEnabled: true };

        let canvas, ctx, scoreEl;

        class Orb {
            constructor(x, y, tier) {
                this.x = x; this.y = y; this.tier = tier; this.bsod = (tier === -1);
                this.r = this.bsod ? 24 : 10 + tier*4;
                this.vx = (Math.random()-0.5)*2; this.vy = (Math.random()-0.5)*2;
                this.color = this.bsod ? '#0000AA' : CONFIG.colors[tier % CONFIG.colors.length];
                this.dead = false; // æ ‡è®°åˆ é™¤è€Œä¸æ˜¯ç›´æ¥åˆ é™¤ï¼Œé˜²æ­¢å¾ªç¯å‡ºé”™
            }
            update() {
                if(state.pointer.down) {
                    const dx = state.pointer.x - this.x; const dy = state.pointer.y - this.y;
                    const d = Math.sqrt(dx*dx + dy*dy);
                    if(d > 10) { const f = (this.bsod ? 0.1 : 0.5) / (this.r * 0.1); this.vx += (dx/d)*f; this.vy += (dy/d)*f; }
                }
                this.vx *= CONFIG.friction; this.vy *= CONFIG.friction;
                this.x += this.vx; this.y += this.vy;
                if(this.x < this.r) { this.x = this.r; this.vx *= -CONFIG.bounce; }
                if(this.x > state.width - this.r) { this.x = state.width - this.r; this.vx *= -CONFIG.bounce; }
                if(this.y < this.r) { this.y = this.r; this.vy *= -CONFIG.bounce; }
                if(this.y > state.height - this.r) { this.y = state.height - this.r; this.vy *= -CONFIG.bounce; }
            }
            draw() {
                if(this.bsod) {
                    ctx.fillStyle = this.color; ctx.fillRect(this.x-this.r, this.y-this.r, this.r*2, this.r*2);
                    ctx.strokeStyle = 'white'; ctx.strokeRect(this.x-this.r, this.y-this.r, this.r*2, this.r*2);
                    ctx.fillStyle = 'white'; ctx.font = '9px monospace'; ctx.textAlign = 'center'; ctx.fillText('ERR', this.x, this.y-2); ctx.fillText('0x0E', this.x, this.y+8);
                } else {
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
                    ctx.fillStyle = this.color; ctx.fill(); ctx.strokeStyle = 'rgba(0,0,0,0.5)'; ctx.stroke();
                    ctx.fillStyle = 'white'; ctx.fillRect(this.x - this.r/2, this.y - this.r/2, 3, 3);
                }
            }
        }

        class Part {
            constructor(x, y, c) { this.x=x; this.y=y; this.c=c; this.vx=(Math.random()-0.5)*8; this.vy=(Math.random()-0.5)*8; this.life=1.0; }
            update() { this.x+=this.vx; this.y+=this.vy; this.life-=0.1; } // åŠ å¿«æ¶ˆå¤±é€Ÿåº¦ï¼Œå‡å°‘æ¸²æŸ“å‹åŠ›
            draw() { ctx.globalAlpha=this.life; ctx.fillStyle=this.c; ctx.fillRect(this.x, this.y, 3, 3); ctx.globalAlpha=1; }
        }

        function spawn(tier) { if(state.orbs.length < 60) state.orbs.push(new Orb(Math.random()*state.width, Math.random()*state.height, tier)); }
        
        // [å…³é”®ä¿®å¤]ï¼šé™åˆ¶ç²’å­æ€»æ•°ï¼Œé˜²æ­¢æ˜¾å¡å‹åŠ›
        function explode(x, y, c) { 
            if(state.particles.length > 80) return; 
            for(let i=0; i<6; i++) state.particles.push(new Part(x, y, c)); 
        }

        // [å…³é”®ä¿®å¤]ï¼šå®‰å…¨çš„ç¢°æ’é€»è¾‘ï¼Œé¿å…æ•°ç»„è¶Šç•Œå’Œæ­»å¾ªç¯
        function check() {
            // å…ˆæ¸…é™¤å·²æ ‡è®°æ­»äº¡çš„
            state.orbs = state.orbs.filter(o => !o.dead);

            for(let i=0; i<state.orbs.length; i++) {
                let a = state.orbs[i];
                if(a.dead) continue;

                for(let j=i+1; j<state.orbs.length; j++) {
                    let b = state.orbs[j];
                    if(b.dead) continue;

                    let dx = b.x - a.x, dy = b.y - a.y;
                    let distSq = dx*dx + dy*dy; // ä½¿ç”¨å¹³æ–¹è·ç¦»æ¯”è¾ƒï¼Œç•¥å¾®æå‡æ€§èƒ½
                    let min = a.r + b.r;
                    
                    if(distSq < min*min) {
                        // ç¢°æ’åå¼¹é€»è¾‘
                        let angle = Math.atan2(dy, dx);
                        let tx = a.x + Math.cos(angle)*min, ty = a.y + Math.sin(angle)*min;
                        let ax = (tx-b.x)*0.05, ay = (ty-b.y)*0.05;
                        a.vx -= ax; a.vy -= ay; b.vx += ax; b.vy += ay;

                        if(a.bsod || b.bsod) {
                            // BSOD è§¦å‘ï¼šç›´æ¥æ ‡è®°æ­»äº¡ï¼Œä¸é€’å½’
                            a.dead = true; b.dead = true;
                            AudioEngine.bsod(); 
                            state.score += 500;
                            // ç®€å•çš„è§†è§‰åé¦ˆ
                            canvas.style.backgroundColor = '#000080';
                            setTimeout(() => canvas.style.backgroundColor = '#000000', 50);
                            return; // ç«‹å³è·³å‡ºå½“å‰å¾ªç¯ï¼Œé˜²æ­¢è¿é”ååº”å¡æ­»
                        }
                        
                        if(a.tier === b.tier && !a.bsod && !b.bsod) {
                            a.dead = true; b.dead = true;
                            state.score += (a.tier+1)*10; 
                            if(scoreEl) scoreEl.innerText = state.score;
                            AudioEngine.play(220 + a.tier*50); 
                            explode(a.x, a.y, a.color);
                            // æ–°ç”Ÿæˆçš„çƒæ”¾åœ¨ä¸‹ä¸€å¸§å¤„ç†
                            setTimeout(() => spawn(a.tier+1), 0);
                        }
                    }
                }
            }
        }

        function loop() {
            if(!state.gameActive) return;
            
            // ç¡®ä¿å°ºå¯¸åŒæ­¥
            const container = document.getElementById('game-container');
            if(container) {
                const rect = container.getBoundingClientRect();
                if(rect.width > 0 && (canvas.width !== rect.width || canvas.height !== rect.height)) {
                    canvas.width = rect.width; canvas.height = rect.height; state.width = rect.width; state.height = rect.height;
                }
            }

            // ç»˜åˆ¶
            ctx.fillStyle = 'black'; ctx.fillRect(0,0,state.width, state.height);
            ctx.strokeStyle = '#003300'; ctx.lineWidth=1; ctx.beginPath();
            for(let i=0; i<state.width; i+=40) { ctx.moveTo(i,0); ctx.lineTo(i, state.height); }
            for(let i=0; i<state.height; i+=40) { ctx.moveTo(0,i); ctx.lineTo(state.width, i); }
            ctx.stroke();

            // å¼•åŠ›çº¿
            if(state.pointer.down) {
                ctx.strokeStyle = '#0f0'; ctx.lineWidth=1;
                ctx.beginPath(); ctx.moveTo(state.pointer.x-10, state.pointer.y); ctx.lineTo(state.pointer.x+10, state.pointer.y);
                ctx.moveTo(state.pointer.x, state.pointer.y-10); ctx.lineTo(state.pointer.x, state.pointer.y+10); ctx.stroke();
            }

            check(); // ç‰©ç†æ£€æµ‹

            // æ¸²æŸ“ Orb
            state.orbs.forEach(o => { if(!o.dead) { o.update(); o.draw(); } });
            
            // æ¸²æŸ“ç²’å­
            state.particles.forEach(p => { p.update(); p.draw(); });
            state.particles = state.particles.filter(p => p.life>0);

            // ç”Ÿæˆé€»è¾‘
            state.frame++;
            if(state.frame % state.currentSpawnRate === 0) {
                if(state.bsodEnabled && Math.random()<0.08) spawn(-1); else spawn(0);
            }

            requestAnimationFrame(loop);
        }

        // --- å…¨å±€æ¥å£ ---
        window.openGame = function() { wins.game.classList.remove('hidden'); if(!state.gameActive) { state.gameActive=true; loop(); } }
        window.closeGame = function() { wins.game.classList.add('hidden'); state.gameActive=false; }
        
        window.openDialup = function() { wins.dial.classList.remove('hidden'); document.getElementById('dial-status').innerText = ""; }
        window.closeDialup = function() { wins.dial.classList.add('hidden'); }
        
        window.startConnection = function() {
            const status = document.getElementById('dial-status');
            status.innerText = "æ­£åœ¨æ‹¨å·...";
            AudioEngine.init(); AudioEngine.playDialSound();
            setTimeout(() => {
                status.innerText = "æ­£åœ¨éªŒè¯...";
                setTimeout(() => { window.closeDialup(); wins.net.classList.remove('hidden'); }, 1000);
            }, 1000);
        }
        window.closeNet = function() { wins.net.classList.add('hidden'); }

        const trashJokes = ["é”™è¯¯ï¼šæ— æ³•åˆ é™¤ 'å‘¨ä¸€'ã€‚", "å›æ”¶ç«™å·²æ»¡ã€‚", "CPU éœ€è¦ä¼‘æ¯ã€‚", "404 Error: Trash not found."];
        window.trashTalk = function() {
            window.showMsg("Explorer", trashJokes[Math.floor(Math.random() * trashJokes.length)]);
        }

        window.showMsg = function(title, text) {
            document.getElementById('msg-title').innerText = title; document.getElementById('msg-text').innerText = text;
            wins.msg.classList.remove('hidden');
            if(AudioEngine.enabled) AudioEngine.play(150, 'triangle');
        }
        window.closeMsg = function() { wins.msg.classList.add('hidden'); }

        window.systemReboot = function() {
            const bios = document.getElementById('bios-screen'); const mem = document.getElementById('mem-test'); const details = document.getElementById('bios-details');
            state.gameActive = false; state.orbs = []; state.particles = []; state.score = 0; if(scoreEl) scoreEl.innerText = "0";
            bios.style.display = 'flex'; details.style.display = 'none'; mem.innerText = '0';
            if(AudioEngine.enabled) AudioEngine.play(800, 'square'); 
            let memory = 0;
            const memInterval = setInterval(() => {
                memory += 4096; mem.innerText = memory;
                if(memory >= 65536) {
                    clearInterval(memInterval); details.style.display = 'block';
                    setTimeout(() => {
                        bios.style.display = 'none';
                        if(!wins.game.classList.contains('hidden')) { state.gameActive = true; for(let i=0; i<5; i++) spawn(0); loop(); }
                    }, 2000);
                }
            }, 50);
        }

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            wins.game = document.getElementById('game-window'); wins.dial = document.getElementById('dial-window');
            wins.net = document.getElementById('net-window'); wins.msg = document.getElementById('msg-window');
            canvas = document.getElementById('gameCanvas'); ctx = canvas.getContext('2d'); scoreEl = document.getElementById('score');

            // è¾“å…¥
            const container = document.getElementById('game-container');
            const updatePtr = (e) => {
                const rect = canvas.getBoundingClientRect();
                const cx = e.touches ? e.touches[0].clientX : e.clientX; const cy = e.touches ? e.touches[0].clientY : e.clientY;
                state.pointer.x = cx - rect.left; state.pointer.y = cy - rect.top;
            };
            const startHandler = (e) => {
                if(e.target.tagName === 'BUTTON' || e.target.parentElement.tagName === 'BUTTON') return;
                state.pointer.down = true; updatePtr(e); document.getElementById('tutorial').style.display = 'none';
            };
            container.addEventListener('mousedown', startHandler); container.addEventListener('mousemove', (e)=>{ if(state.pointer.down) updatePtr(e); });
            window.addEventListener('mouseup', ()=>{ state.pointer.down=false; });
            container.addEventListener('touchstart', (e)=>{ e.preventDefault(); startHandler(e); }, {passive:false});
            container.addEventListener('touchmove', (e)=>{ e.preventDefault(); updatePtr(e); }, {passive:false});
            window.addEventListener('touchend', ()=>{ state.pointer.down=false; });

            // æŒ‰é’®
            document.getElementById('audioBtn').onclick = (e) => {
                if(e) e.stopPropagation(); AudioEngine.init(); AudioEngine.enabled = !AudioEngine.enabled;
                const btn = document.getElementById('audioBtn'); const icon = document.getElementById('audio-icon');
                if(AudioEngine.enabled) { icon.innerText = "ğŸ”Š"; btn.style.color = "green"; AudioEngine.play(440); } 
                else { icon.innerText = "ğŸ”‡"; btn.style.color = "black"; }
            };
            document.getElementById('speedBtn').onclick = (e) => {
                if(e) e.stopPropagation(); state.speedLevel = (state.speedLevel % 5) + 1;
                document.getElementById('speed-text').innerText = `âš¡ ${state.speedLevel}x`;
                state.currentSpawnRate = Math.floor(CONFIG.baseSpawnRate / state.speedLevel);
                if(AudioEngine.enabled) AudioEngine.play(440 + state.speedLevel*100, 'triangle');
            };
            document.getElementById('bsodBtn').onclick = (e) => {
                if(e) e.stopPropagation(); state.bsodEnabled = !state.bsodEnabled;
                const btn = document.getElementById('bsodBtn'); const txt = document.getElementById('bsod-text');
                if(state.bsodEnabled) { btn.style.color = "darkred"; txt.innerText = "ğŸ’£ å¼€å¯"; } else { btn.style.color = "gray"; txt.innerText = "ğŸ’£ å…³é—­"; }
            };
            document.getElementById('rebootBtn').onclick = (e) => { if(e) e.stopPropagation(); window.systemReboot(); };

            // å¯åŠ¨
            setTimeout(() => { if(wins.game) wins.game.classList.remove('hidden'); state.gameActive = true; for(let i=0; i<5; i++) spawn(0); loop(); }, 100);
        };
    </script>
</body>
</html>

